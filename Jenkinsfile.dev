pipeline {
  agent any

  environment {
    QUALITY_OK = 'false'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Trivy FS Scan (Pré-build)') {
      steps {
        // Scan de vulnerabilidades no código/projeto (filesystem)
        // Requer Trivy instalado no agente Jenkins
        bat 'trivy fs --exit-code 1 --severity HIGH,CRITICAL --quiet . || exit /b 1'
      }
    }

    stage('Build & Test') {
      steps {
        bat 'mvn clean test verify'
      }
    }

    stage('Quality Gate 99%') {
      steps {
        script {
          // O Jacoco já está configurado no pom.xml com minimum 0.99.
          // Se a cobertura for menor que 99%, o mvn verify falha e o pipeline para aqui.
          echo 'Quality Gate Jacoco 99% garantido via maven-jacoco-plugin'
          env.QUALITY_OK = 'true'
        }
      }
    }

    stage('Build Docker Image') {
      when {
        expression { env.QUALITY_OK == 'true' }
      }
      steps {
        bat 'docker build -t devops-main:latest .'
      }
    }

    stage('Trivy Image Scan (Pós-build)') {
      when {
        expression { env.QUALITY_OK == 'true' }
      }
      steps {
        // Scan de vulnerabilidades na imagem Docker construída
        bat 'trivy image --exit-code 1 --severity HIGH,CRITICAL --quiet devops-main:latest || exit /b 1'
      }
    }
  }

  post {
    always {
      junit 'target/surefire-reports/*.xml'
      jacoco execPattern: 'target/jacoco.exec', classPattern: 'target/classes', sourcePattern: 'src/main/java', inclusionPattern: '**/*.class', exclusionPattern: ''
      pmd canComputeNew: false, defaultEncoding: 'UTF-8', pattern: 'target/pmd.xml'
    }
  }
}
